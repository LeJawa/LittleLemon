<html>
  <head>
    {% load static %}
    <title>Capstone Project</title>
    <link rel="stylesheet" href="{% static 'restaurant/style.css' %}">
  </head>
  <body>
    <h1 style="text-align:center;">Welcome to the Little Lemon restaurant</h1>
    <img src="{% static 'restaurant/logo.png' %}">

    <section class="big-container">
      <section class="column-section">
        {% include 'forms/login-form.html' %}
        {% include 'forms/show-menuitem-form.html' %}
      </section>

      <section class="column-section">
        <article id="output">
          <button id="clear-output" hidden>Clear output</button>
          <div id="placeholder-output">
            OUTPUT WILL APPEAR HERE
          </div>
        </article>
      </section>
    </section>

    <script>
      var user_authtoken = null;

      {% comment %} Add numbering to the articles {% endcomment %}
      const form_headers = document.querySelectorAll('.form-header');

      form_headers.forEach((header, index) => {
        const numbering = document.createElement('p');
        numbering.classList.add('numbering');
        numbering.innerHTML = `${index + 1}.`;

        header.insertBefore(numbering, header.firstChild);
      })

      function add_response_to_output(response) {
        console.log(response.status);
        const responsediv = document.createElement('div')
        responsediv.classList.add('response');
        const status = document.createElement('span');
        status.classList.add('status');

        if (response.status.toString().startsWith('4')){
          status.classList.add('status-red');
        } else if (response.status.toString().startsWith('5')){
          status.classList.add('status-blue');
        } else if (response.status.toString().startsWith('2')){
          status.classList.add('status-green');
        }
        const output = document.createElement('span');
        output.classList.add('data');
        status.innerHTML = response.status + " " + response.statusText;
        output.innerHTML = JSON.stringify(response.data, null, 1);

        document.getElementById("output").children[1].after(responsediv);
        responsediv.appendChild(status);
        responsediv.appendChild(output);
        document.getElementById('clear-output').removeAttribute('hidden');
        document.getElementById('placeholder-output').setAttribute('hidden', '');
      }

      function rightFetch(path, method, formData){
        if (method == "GET") {
          return fetch(path, {method: method})
        }
        else if (method == "POST"){
          return fetch(path, {
            method: method,
            body: formData
          })
        }
      }

      function isSuccesful(response) {
        return response.status.toString().startsWith('2');
      }

      const FormAction = {
        LOGIN: 'login',
        LOGOUT: 'logout',
        STANDARD: 'standard'
      }

      function linkFormToOutput(formId, path, method, formAction = FormAction.STANDARD) {
        const form = document.getElementById(formId);

        form.addEventListener('submit', (event) => {
          event.preventDefault(); // The default action is to go to the page in path, but we want to stay on the same page

          const formData = new FormData(form);

          rightFetch(path, method, formData) // This function wraps fetch to be able to accept different methods using the same syntax
          .then(response => { // This step is necessary to inject the status code into the response object
            const status = response.status;
            const statusText = response.statusText;
            return response.json().then(data => ({ status, statusText, data })); // I don't really understand this but it works
          })
          .then(response => {
            add_response_to_output(response);
            
            if (isSuccesful(response)) {
              if (formAction == FormAction.LOGIN) { // Saves the user_authtoken if a login form was used
                user_authtoken = response.data.auth_token;
              }
              else if (formAction == FormAction.LOGOUT) { // Deletes the user_authtoken if a logout form was used
                user_authtoken = null;
              }
            }
          })
          .catch(error => {
            console.error(error);
          });
        })
      }

      linkFormToOutput('login-form', "/auth/token/login", 'POST', FormAction.LOGIN)
      linkFormToOutput('show-menuitem', "{% url 'show_menuitem-list' %}" ,'GET')
      

      const clearOutputButton = document.getElementById('clear-output');

      clearOutputButton.addEventListener('click', () => {
        const outputArticle = document.getElementById('output');
        const responseElements = outputArticle.querySelectorAll('.response');  

        responseElements.forEach((response) => {
          response.remove();
        })

        clearOutputButton.setAttribute('hidden', '');
        document.getElementById('placeholder-output').removeAttribute('hidden');
      })

    </script>




  </body>
</html>